import{w as e}from"./with-resolvers-DgdAhYQ2.js";import{W as t,S as s}from"./async-BRmx_40z.js";import{p as r}from"./channel-CC7a8JrL.js";import{S as a,h as n,u as o,p as i}from"./shared-Dzl101-_.js";import{r as c,b as l}from"./shared-D1EE5wug.js";import"./shared-array-buffer-cwdMr2mc.js";import"./i32-C78nBJH2.js";import"./global-D1K2q6W8.js";const p=new Map,h=new BroadcastChannel(r);h.addEventListener("message",async({data:[e,t]})=>{if("request"===e){const[e,[s,r]]=t,a=p.get(r);if(a){const t=a.get(s);a.delete(s),h.postMessage(["response",[e,await t]])}}});const{promise:d,resolve:f}=e();let m=!0;const u=(e,t)=>{let s,r=!0,{url:a}=t;e.getRegistration(a).then(s=>s??e.register(a,t)).then(function n(o){const{controller:i}=e;if(r=r&&!!i,s=o.installing||o.waiting||o.active,!s)return u(e,t);if("activated"===s.state){if(r){if(i.scriptURL===a)return f();o.unregister()}location.reload()}else s.addEventListener("statechange",()=>n(o),{once:!0})})};class g extends a{#e;constructor(r,a,h){if(m){m=!1;let{serviceWorker:e}=a;if(!e)return new t(r,a,h);"string"==typeof e&&(e={url:e}),e.url=new URL(e.url,location.href).href,u(navigator.serviceWorker,e)}const d=c(),f=new BroadcastChannel(d),g=s(a),v=new Map,w=new Int32Array(g),j=n(g,a,!1);p.set(d,v),f.addEventListener("message",async({data:[t,s]})=>{const{promise:r,resolve:a}=e();v.set(t,r),await j({data:s}),a(new Uint8Array(g,l,w[1]))}),super(...o(r,"xhr",a)),super.addEventListener("message",()=>h(this),{once:!0}),super.postMessage(i(g,a).concat(d)),this.#e=d}terminate(){p.delete(this.#e),super.terminate()}get channel(){return"xhr"}}var v=(s,r)=>{const{promise:a,resolve:n}=e();return new g(s,r,n)instanceof t?a:d.then(()=>a)};export{v as default};

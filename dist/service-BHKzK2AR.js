import{u as e,p as t,h as s,m as r}from"./shared-CWPvHWK8.js";import{S as n}from"./shared-array-buffer-cwdMr2mc.js";import{w as a}from"./with-resolvers-CHEvl4oe.js";const o=new Map,i=new BroadcastChannel("reflected-0123456789");i.addEventListener("message",async({data:[e,t]})=>{if("request"===e){const[e,[s,r]]=t,n=o.get(r);if(n){const t=n.get(s);t&&(n.delete(s),i.postMessage(["response",[e,await t]]))}}});const{promise:c,resolve:l}=a();let d=!0;const h=(e,t)=>{let s,r=!0,{url:n}=t;e.getRegistration(n).then(s=>s??e.register(n,t)).then(function t(a){const{controller:o}=e;if(r=r&&!!o,s=a.installing||a.waiting||a.active,"activated"===s.state){if(r){if(o.scriptURL===n)return l();a.unregister()}location.reload()}else s.addEventListener("statechange",()=>t(a),{once:!0})})};class g extends globalThis.Worker{#e=crypto.randomUUID();constructor(i,c,l){if(d){d=!1;let{serviceWorker:e}=c;"string"==typeof e&&(e={url:e}),e.url=new URL(e.url,location.href).href,h(navigator.serviceWorker,e)}const g=crypto.randomUUID(),p=new BroadcastChannel(g),m=(({initByteLength:e=1024,maxByteLength:t=8192})=>new n(r+e,{maxByteLength:r+t}))(c),u=new Map,f=new Int32Array(m),v=s(m,c,!1);o.set(g,u),p.addEventListener("message",async({data:[e,t]})=>{const{promise:s,resolve:r}=a();u.set(e,s),await v({data:t}),r(f.slice(0,2+f[1]))}),super(...e(i,"service",c)),super.addEventListener("message",()=>l(this),{once:!0}),super.postMessage(t(m,c).concat(g)),this.#e=g}terminate(){o.delete(this.#e),super.terminate()}get channel(){return"service"}}var p=(e,t)=>{const{promise:s,resolve:r}=a();return new g(e,t,r),c.then(()=>s)};export{p as default};

import{w as e}from"./with-resolvers-CHEvl4oe.js";import{W as t,S as s}from"./async-CKeQT1Lz.js";import{S as r}from"./channel-CdS9bLt4.js";import{S as a,u as n,p as o,h as i}from"./shared-MkVjuKUg.js";import{r as c}from"./shared-RFmxa5x4.js";import"./shared-array-buffer-cwdMr2mc.js";import"./i32-C78nBJH2.js";const l=new Map,d=new BroadcastChannel(r);d.addEventListener("message",async({data:[e,t]})=>{if("request"===e){const[e,[s,r]]=t,a=l.get(r);a&&(d.postMessage(["response",[e,await a.get(s)]]),a.delete(s))}});const{promise:h,resolve:p}=e();let f=!0;const m=(e,t)=>{let s,r=!0,{url:a}=t;e.getRegistration(a).then(s=>s??e.register(a,t)).then(function n(o){const{controller:i}=e;if(r=r&&!!i,s=o.installing||o.waiting||o.active,!s)return m(e,t);if("activated"===s.state){if(r){if(i.scriptURL===a)return p();o.unregister()}location.reload()}else s.addEventListener("statechange",()=>n(o),{once:!0})})};class u extends a{#e;constructor(r,a,d){if(f){f=!1;let{serviceWorker:e}=a;if(!e)return new t(r,a,d);"string"==typeof e&&(e={url:e}),e.url=new URL(e.url,location.href).href,m(navigator.serviceWorker,e)}const h=c(),p=new BroadcastChannel(h),u=s(a),g=new Map,v=new Int32Array(u),w=i(u,a,!1);l.set(h,g),p.addEventListener("message",async({data:[t,s]})=>{const{promise:r,resolve:a}=e();g.set(t,r),await w({data:s}),a(v.slice(0,2+v[1]))}),super(...n(r,"xhr",a)),super.addEventListener("message",()=>d(this),{once:!0}),super.postMessage(o(u,a).concat(h)),this.#e=h}terminate(){l.delete(this.#e),super.terminate()}get channel(){return"xhr"}}var g=(s,r)=>{const{promise:a,resolve:n}=e();return new u(s,r,n)instanceof t?a:h.then(()=>a)};export{g as default};

import{w as e}from"./with-resolvers-CHEvl4oe.js";import{W as t,S as s}from"./async-DmtVd3fa.js";import{r}from"./channel-DQBWE7_E.js";import{S as n,h as a,u as o,p as i}from"./shared-DoovxK7Z.js";import{r as c,b as l}from"./shared-D1EE5wug.js";import"./shared-array-buffer-cwdMr2mc.js";import"./i32-C78nBJH2.js";const d=new Map,h=new BroadcastChannel(r);h.addEventListener("message",async({data:[e,t]})=>{if("request"===e){const[e,[s,r]]=t,n=d.get(r);if(n){const t=n.get(s);n.delete(s),h.postMessage(["response",[e,await t]])}}});const{promise:p,resolve:f}=e();let m=!0;const u=(e,t)=>{let s,r=!0,{url:n}=t;e.getRegistration(n).then(s=>s??e.register(n,t)).then(function a(o){const{controller:i}=e;if(r=r&&!!i,s=o.installing||o.waiting||o.active,!s)return u(e,t);if("activated"===s.state){if(r){if(i.scriptURL===n)return f();o.unregister()}location.reload()}else s.addEventListener("statechange",()=>a(o),{once:!0})})};class g extends n{#e;constructor(r,n,h){if(m){m=!1;let{serviceWorker:e}=n;if(!e)return new t(r,n,h);"string"==typeof e&&(e={url:e}),e.url=new URL(e.url,location.href).href,u(navigator.serviceWorker,e)}const p=c(),f=new BroadcastChannel(p),g=s(n),v=new Map,w=new Int32Array(g),j=a(g,n,!1);d.set(p,v),f.addEventListener("message",async({data:[t,s]})=>{const{promise:r,resolve:n}=e();v.set(t,r),await j({data:s}),n(new Uint8Array(g,l,w[1]))}),super(...o(r,"xhr",n)),super.addEventListener("message",()=>h(this),{once:!0}),super.postMessage(i(g,n).concat(p)),this.#e=p}terminate(){d.delete(this.#e),super.terminate()}get channel(){return"xhr"}}var v=(s,r)=>{const{promise:n,resolve:a}=e();return new g(s,r,a)instanceof t?n:p.then(()=>n)};export{v as default};

const e=Promise.withResolvers||function(){var e,t,s=new this((s,n)=>{e=s,t=n});return{resolve:e,reject:t,promise:s}};var t=e.bind(Promise),s=e=>{const t=new Int32Array(1);return()=>t[0]++},n="353932a0-9595-4ff9-9b6b-53b3f14ebbe3";const{isArray:r}=Array;class a extends Worker{#e;#t;constructor(e,t){super(e,t),this.#e=s(),this.#t=new Map,super.addEventListener("message",async e=>{const{data:s}=e;if(r(s)&&s[0]===n){e.stopImmediatePropagation(),e.preventDefault();const[n,r]=s[1],[a,o]=this.#t.get(n);this.#t.delete(n),a(await t.onsend(r,...o))}})}send(e,...s){const r=this.#e(),{promise:a,resolve:o}=t();return this.#t.set(r,[o,s]),super.postMessage([n,[r,e]],...s),a}}let{SharedArrayBuffer:o}=globalThis;try{new o(4,{maxByteLength:8})}catch(e){o=class extends ArrayBuffer{get growable(){return super.resizable}grow(e){super.resize(e)}}}const c=2*Int32Array.BYTES_PER_ELEMENT,i=(e,t,s)=>{const n=new Int32Array(e);return async({data:s})=>{const r=await t.ondata(s),a=r.length,o=c+r.buffer.byteLength;e.byteLength<o&&e.grow(o),n.set(r,2),n[1]=a,n[0]=1}},l=e=>{switch(typeof e){case"symbol":case"function":return!1}return!0},d=(e,t)=>{const s={};for(const e in t){const n=t[e];l(e)&&l(n)&&(s[e]=n)}return[e,s]},u=(e,t,s)=>{const n=new URL(e,location.href);return n.searchParams.set("reflected",t),[n,{...s,type:"module"}]};var p=({initByteLength:e=1024,maxByteLength:t=8192})=>new o(c+e,{maxByteLength:c+t});let g=!0;try{crypto.randomUUID()}catch(e){g=!1}const h=g?()=>crypto.randomUUID():()=>(Date.now()+Math.random()).toString(36),y="async";let f=class extends a{constructor(e,t,s){const n=h(),r=new BroadcastChannel(n),a=p(t),o=new Int32Array(a),c=i(a,t);r.addEventListener("message",async({data:[e,t]})=>{await c({data:t}),r.postMessage([e,o.slice(0,2+o[1])])}),super(...u(e,y,t)),super.addEventListener("message",()=>s(this),{once:!0}),super.postMessage(d(a,t).concat(n))}get channel(){return y}};const w=new Map,m=new BroadcastChannel(n);m.addEventListener("message",async({data:[e,t]})=>{if("request"===e){const[e,[s,n]]=t,r=w.get(n);if(r){const t=r.get(s);t&&(r.delete(s),m.postMessage(["response",[e,await t]]))}}});const{promise:v,resolve:L}=t();let b=!0;let x=class extends a{#s;constructor(e,s,n){if(b){b=!1;let{serviceWorker:t}=s;if(!t)return new f(e,s,n);"string"==typeof t&&(t={url:t}),t.url=new URL(t.url,location.href).href,((e,t)=>{let s,n=!0,{url:r}=t;e.getRegistration(r).then(s=>s??e.register(r,t)).then(function t(a){const{controller:o}=e;if(n=n&&!!o,s=a.installing||a.waiting||a.active,"activated"===s.state){if(n){if(o.scriptURL===r)return L();a.unregister()}location.reload()}else s.addEventListener("statechange",()=>t(a),{once:!0})})})(navigator.serviceWorker,t)}const r=h(),a=new BroadcastChannel(r),o=p(s),c=new Map,l=new Int32Array(o),g=i(o,s);w.set(r,c),a.addEventListener("message",async({data:[e,s]})=>{const{promise:n,resolve:r}=t();c.set(e,n),await g({data:s}),r(l.slice(0,2+l[1]))}),super(...u(e,"xhr",s)),super.addEventListener("message",()=>n(this),{once:!0}),super.postMessage(d(o,s).concat(r)),this.#s=r}terminate(){w.delete(this.#s),super.terminate()}get channel(){return"xhr"}};const{isArray:E}=Array;const{parse:M,stringify:A}=JSON,{promise:B,resolve:I}=t();addEventListener("message",({data:[e,t,s]})=>I([e,t,s]),{once:!0});const q="xhr";var R="importScripts"in globalThis?e=>B.then(([t,r,a])=>(postMessage(1),((e,t,n)=>{const r=new BroadcastChannel(e),a=s(),{serviceWorker:o}=n;return(s,...c)=>{const i=a();r.postMessage([i,s],...c);const l=new XMLHttpRequest;return l.open("POST",o,!1),l.setRequestHeader("Content-Type","application/json"),l.send(A([i,e])),t.set(M(l.responseText),0),n.ondata(t.subarray(2,2+t[1]))}})(a,new Int32Array(t),(e=>(addEventListener("message",async t=>{const{data:s}=t;if(E(s)&&s[0]===n){t.stopImmediatePropagation(),t.preventDefault();const[r,a]=s[1];postMessage([n,[r,await e.onsend(a)]])}}),e))({...r,...e})))):(e,s)=>{const{promise:n,resolve:r}=t();return new x(e,s,r)instanceof f?n:v.then(()=>n)};export{q as channel,R as default};
